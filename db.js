const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');
const path = require('path');

const dbDir = path.join(__dirname, 'db');
const dbPath = path.join(dbDir, 'sqlite.db');

// 確保 db 目錄存在
if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir);
}

// 檢查資料庫檔案是否存在
const dbExists = fs.existsSync(dbPath);

// 開啟資料庫
const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('無法開啟資料庫:', err.message);
    } else {
        if (!dbExists) {
            console.log('資料庫不存在，已建立新的資料庫。');
        } else {
            console.log('成功開啟資料庫。');
        }

        db.serialize(() => {
            db.run(`CREATE TABLE IF NOT EXISTS ChocolatePrices (
                ID INTEGER PRIMARY KEY AUTOINCREMENT,
                ProductName TEXT NOT NULL,
                Date DATE NOT NULL,
                Price REAL NOT NULL,
                AnnualGrowthRate REAL
            )`, (err) => {
                if (err) {
                    console.error('建立 ChocolatePrices 資料表時發生錯誤:', err.message);
                } else {
                    console.log('已確認 ChocolatePrices 資料表存在。');
                    // 插入資料
                    const insertStmt = db.prepare(`INSERT INTO ChocolatePrices (ProductName, Date, Price, AnnualGrowthRate) VALUES (?, ?, ?, ?)`);
                    const data = [
                        // ["ProductName", "Date", Price, AnnualGrowthRate]
                        ["巧克力", "2013-01", 86.24, null],
                        ["巧克力", "2013-02", 84.36, null],
                        ["巧克力", "2013-03", 89.28, null],
                        ["巧克力", "2013-04", 90.75, null],
                        ["巧克力", "2013-05", 90.5, null],
                        ["巧克力", "2013-06", 91.49, null],
                        ["巧克力", "2013-07", 91.52, null],
                        ["巧克力", "2013-08", 88.7, null],
                        ["巧克力", "2013-09", 87.74, null],
                        ["巧克力", "2013-10", 87.89, null],
                        ["巧克力", "2013-11", 88.64, null],
                        ["巧克力", "2013-12", 87.35, null],
                        ["巧克力", "2014-01", 88.2, 2.27],
                        ["巧克力", "2014-02", 85.47, 1.32],
                        ["巧克力", "2014-03", 87.09, -2.45],
                        ["巧克力", "2014-04", 88.46, -2.52],
                        ["巧克力", "2014-05", 90.61, 0.12],
                        ["巧克力", "2014-06", 90.34, -1.26],
                        ["巧克力", "2014-07", 91, -0.57],
                        ["巧克力", "2014-08", 91.33, 2.97],
                        ["巧克力", "2014-09", 90.78, 3.46],
                        ["巧克力", "2014-10", 93.15, 5.98],
                        ["巧克力", "2014-11", 91.46, 3.18],
                        ["巧克力", "2014-12", 89.09, 1.99],
                        ["巧克力", "2015-01", 89.59, 1.58],
                        ["巧克力", "2015-02", 89.8, 5.07],
                        ["巧克力", "2015-03", 91.66, 5.25],
                        ["巧克力", "2015-04", 92.38, 4.43],
                        ["巧克力", "2015-05", 90.34, -0.3],
                        ["巧克力", "2015-06", 92.8, 2.72],
                        ["巧克力", "2015-07", 92.35, 1.48],
                        ["巧克力", "2015-08", 89.19, -2.34],
                        ["巧克力", "2015-09", 90.96, 0.2],
                        ["巧克力", "2015-10", 91.02, -2.29],
                        ["巧克力", "2015-11", 91.85, 0.43],
                        ["巧克力", "2015-12", 87.64, -1.63],
                        ["巧克力", "2016-01", 88.98, -0.68],
                        ["巧克力", "2016-02", 85.8, -4.45],
                        ["巧克力", "2016-03", 89.07, -2.83],
                        ["巧克力", "2016-04", 91.79, -0.64],
                        ["巧克力", "2016-05", 91.32, 1.08],
                        ["巧克力", "2016-06", 91.46, -1.44],
                        ["巧克力", "2016-07", 88.61, -4.05],
                        ["巧克力", "2016-08", 90.18, 1.11],
                        ["巧克力", "2016-09", 89.86, -1.21],
                        ["巧克力", "2016-10", 90.3, -0.79],
                        ["巧克力", "2016-11", 91.21, -0.7],
                        ["巧克力", "2016-12", 91.95, 4.92],
                        ["巧克力", "2017-01", 89.28, 0.34],
                        ["巧克力", "2017-02", 89.42, 4.22],
                        ["巧克力", "2017-03", 91.21, 2.4],
                        ["巧克力", "2017-04", 94.47, 2.92],
                        ["巧克力", "2017-05", 94.47, 3.45],
                        ["巧克力", "2017-06", 97.64, 6.76],
                        ["巧克力", "2017-07", 96.84, 9.29],
                        ["巧克力", "2017-08", 92.31, 2.36],
                        ["巧克力", "2017-09", 93.65, 4.22],
                        ["巧克力", "2017-10", 94.23, 4.35],
                        ["巧克力", "2017-11", 90.83, -0.42],
                        ["巧克力", "2017-12", 93.01, 1.15],
                        ["巧克力", "2018-01", 88.81, -0.53],
                        ["巧克力", "2018-02", 90.96, 1.72],
                        ["巧克力", "2018-03", 92.34, 1.24],
                        ["巧克力", "2018-04", 93.85, -0.66],
                        ["巧克力", "2018-05", 93.88, -0.62],
                        ["巧克力", "2018-06", 95.06, -2.64],
                        ["巧克力", "2018-07", 93, -3.97],
                        ["巧克力", "2018-08", 90.9, -1.53],
                        ["巧克力", "2018-09", 95.57, 2.05],
                        ["巧克力", "2018-10", 94.87, 0.68],
                        ["巧克力", "2018-11", 90.85, 0.02],
                        ["巧克力", "2018-12", 91.5, -1.62],
                        ["巧克力", "2019-01", 87.73, -1.22],
                        ["巧克力", "2019-02", 91.16, 0.22],
                        ["巧克力", "2019-03", 92.32, -0.02],
                        ["巧克力", "2019-04", 92.4, -1.55],
                        ["巧克力", "2019-05", 93.48, -0.43],
                        ["巧克力", "2019-06", 96.98, 2.02],
                        ["巧克力", "2019-07", 93.83, 0.89],
                        ["巧克力", "2019-08", 92.89, 2.19],
                        ["巧克力", "2019-09", 94.62, -0.99],
                        ["巧克力", "2019-10", 95.42, 0.58],
                        ["巧克力", "2019-11", 92.05, 1.32],
                        ["巧克力", "2019-12", 92.48, 1.07],
                        ["巧克力", "2020-01", 89.61, 2.14],
                        ["巧克力", "2020-02", 91.53, 0.41],
                        ["巧克力", "2020-03", 94.56, 2.43],
                        ["巧克力", "2020-04", 91.14, -1.36],
                        ["巧克力", "2020-05", 94.16, 0.73],
                        ["巧克力", "2020-06", 94.22, -2.85],
                        ["巧克力", "2020-07", 98.22, 4.68],
                        ["巧克力", "2020-08", 98.37, 5.9],
                        ["巧克力", "2020-09", 97.6, 3.15],
                        ["巧克力", "2020-10", 97.08, 1.74],
                        ["巧克力", "2020-11", 98.51, 7.02],
                        ["巧克力", "2020-12", 98.19, 6.17],
                        ["巧克力", "2021-01", 96.67, 7.88],
                        ["巧克力", "2021-02", 97.83, 6.88],
                        ["巧克力", "2021-03", 99.99, 5.74],
                        ["巧克力", "2021-04", 99.99, 9.71],
                        ["巧克力", "2021-05", 101.21, 7.49],
                        ["巧克力", "2021-06", 101.51, 7.74],
                        ["巧克力", "2021-07", 102.33, 4.18],
                        ["巧克力", "2021-08", 101.15, 2.83],
                        ["巧克力", "2021-09", 101.72, 4.22],
                        ["巧克力", "2021-10", 100.12, 3.13],
                        ["巧克力", "2021-11", 98.15, -0.37],
                        ["巧克力", "2021-12", 99.32, 1.15],
                        ["巧克力", "2022-01", 97.73, 1.1],
                        ["巧克力", "2022-02", 96.98, -0.87],
                        ["巧克力", "2022-03", 98.58, -1.41],
                        ["巧克力", "2022-04", 99.07, -0.92],
                        ["巧克力", "2022-05", 100.79, -0.41],
                        ["巧克力", "2022-06", 102.31, 0.79],
                        ["巧克力", "2022-07", 102.74, 0.4],
                        ["巧克力", "2022-08", 103, 1.83],
                        ["巧克力", "2022-09", 102.76, 1.02],
                        ["巧克力", "2022-10", 102.6, 2.48],
                        ["巧克力", "2022-11", 102.92, 4.86],
                        ["巧克力", "2022-12", 100.45, 1.14],
                        ["巧克力", "2023-01", 99.56, 1.87],
                        ["巧克力", "2023-02", 100.73, 3.87],
                        ["巧克力", "2023-03", 100.13, 1.57],
                        ["巧克力", "2023-04", 104.56, 5.54],
                        ["巧克力", "2023-05", 105.49, 4.66],
                        ["巧克力", "2023-06", 105.86, 3.47],
                        ["巧克力", "2023-07", 107.29, 4.43],
                        ["巧克力", "2023-08", 108.93, 5.76],
                        ["巧克力", "2023-09", 106.58, 3.72],
                        ["巧克力", "2023-10", 106.16, 3.47],
                        ["巧克力", "2023-11", 104.96, 1.98],
                        ["巧克力", "2023-12", 103.58, 3.12],
                        ["巧克力", "2024-01", 104.15, 4.61],
                        ["巧克力", "2024-02", 103.34, 2.59],
                        ["巧克力", "2024-03", 107.14, 7],
                        ["巧克力", "2024-04", 104.04, -0.5],
                        ["巧克力", "2024-05", 103.67, -1.73],
                        ["巧克力", "2024-06", 103.55, -2.18],
                        ["巧克力", "2024-07", 108.2, 0.85],
                        ["巧克力", "2024-08", 110.04, 1.02],
                        ["巧克力", "2024-09", 108.66, 1.95],
                        ["巧克力", "2024-10", 106.89, 0.69],
                        ["巧克力", "2024-11", 107.74, 2.65],
                        ["巧克力", "2024-12", 103.64, 0.06]
                    ];
                    data.forEach(row => {
                        insertStmt.run(row, (err) => {
                            if (err) {
                                // 若已存在則略過
                                if (err.message.indexOf('UNIQUE constraint failed') === -1) {
                                    console.error('插入資料時發生錯誤:', err.message);
                                }
                            }
                        });
                    });
                    insertStmt.finalize();
                }
            });
        });
    }
});

module.exports = db;

